(window.webpackJsonp=window.webpackJsonp||[]).push([[30],{322:function(e,n,t){"use strict";t.r(n);var d=t(4),o=Object(d.a)({},(function(){var e=this,n=e._self._c;return n("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[n("h1",{attrs:{id:"diff算法看不懂就一起来锤我"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#diff算法看不懂就一起来锤我"}},[e._v("#")]),e._v(" DIff算法看不懂就一起来锤我")]),e._v(" "),n("blockquote",[n("p",[n("a",{attrs:{href:"https://mp.weixin.qq.com/s/vAt4oCMwa8Bsd3Wb2YfrYg",target:"_blank",rel:"noopener noreferrer"}},[e._v("https://mp.weixin.qq.com/s/vAt4oCMwa8Bsd3Wb2YfrYg"),n("OutboundLink")],1)])]),e._v(" "),n("h1",{attrs:{id:"前言"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#前言"}},[e._v("#")]),e._v(" 前言")]),e._v(" "),n("p",[e._v('面试官:"你了解'),n("code",[e._v("虚拟DOM(Virtual DOM)")]),e._v("跟"),n("code",[e._v("Diff算法")]),e._v('吗,请描述一下它们";')]),e._v(" "),n("p",[e._v('我:"额,...鹅,那个",完了😰,突然智商不在线,没组织好语言没答好或者压根就答不出来;')]),e._v(" "),n("p",[e._v("所以这次我总结一下相关的知识点,让你可以有一个清晰的认知之余也会让你在今后遇到这种情况可以"),n("strong",[e._v("坦然自若,应付自如,游刃有余")]),e._v(":")]),e._v(" "),n("hr"),e._v(" "),n("h2",{attrs:{id:"相关知识点"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#相关知识点"}},[e._v("#")]),e._v(" 相关知识点:")]),e._v(" "),n("ul",[n("li",[n("p",[e._v("虚拟DOM(Virtual DOM):")])]),e._v(" "),n("li",[n("ul",[n("li",[n("strong",[e._v("什么是虚拟dom")])]),e._v(" "),n("li",[n("strong",[e._v("为什么要使用虚拟dom")])]),e._v(" "),n("li",[e._v("虚拟DOM库")])])]),e._v(" "),n("li",[n("p",[e._v("DIFF算法:")])]),e._v(" "),n("li",[n("ul",[n("li",[e._v("init函数")]),e._v(" "),n("li",[e._v("h函数")]),e._v(" "),n("li",[n("strong",[e._v("patch函数")])]),e._v(" "),n("li",[n("strong",[e._v("patchVnode函数")])]),e._v(" "),n("li",[n("strong",[e._v("updateChildren函数")])]),e._v(" "),n("li",[e._v("snabbDom源码")])])])]),e._v(" "),n("hr"),e._v(" "),n("h2",{attrs:{id:"虚拟dom-virtual-dom"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#虚拟dom-virtual-dom"}},[e._v("#")]),e._v(" 虚拟DOM(Virtual DOM)")]),e._v(" "),n("h3",{attrs:{id:"什么是虚拟dom"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#什么是虚拟dom"}},[e._v("#")]),e._v(" 什么是虚拟DOM")]),e._v(" "),n("p",[e._v("一句话总结虚拟DOM就是一个用来描述真实DOM的"),n("strong",[e._v("javaScript对象")]),e._v(",这样说可能不够形象,那我们来举个🌰:分别用代码来描述"),n("code",[e._v("真实DOM")]),e._v("以及"),n("code",[e._v("虚拟DOM")])]),e._v(" "),n("p",[n("code",[e._v("真实DOM")]),e._v(":")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('<ul class="list">\n    <li>a</li>\n    <li>b</li>\n    <li>c</li>\n</ul>\n复制代码\n')])])]),n("p",[n("code",[e._v("对应的虚拟DOM")]),e._v(":")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("let vnode = h('ul.list', [\n  h('li','a'),\n  h('li','b'),\n  h('li','c'),\n])\n\nconsole.log(vnode)\n复制代码\n")])])]),n("h4",{attrs:{id:"控制台打印出来的vnode"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#控制台打印出来的vnode"}},[e._v("#")]),e._v(" 控制台打印出来的"),n("strong",[e._v("Vnode")]),e._v(":")]),e._v(" "),n("p",[n("img",{attrs:{src:"https://mmbiz.qpic.cn/sz_mmbiz_png/H8M5QJDxMHrBPOs1OFIWuxw354WxNWGLfDQbT3YnicB8GCBnDpF4K3uCL9yt7F05tKuwS1kxMIrAkLcCic7zK2Dw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}}),e._v("image.png")]),e._v(" "),n("h4",{attrs:{id:"h函数生成的虚拟dom这个js对象-vnode-的源码"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#h函数生成的虚拟dom这个js对象-vnode-的源码"}},[e._v("#")]),e._v(" h函数生成的虚拟DOM这个JS对象(Vnode)的源码:")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("export interface VNodeData {\n    props?: Props\n    attrs?: Attrs\n    class?: Classes\n    style?: VNodeStyle\n    dataset?: Dataset\n    on?: On\n    hero?: Hero\n    attachData?: AttachData\n    hook?: Hooks\n    key?: Key\n    ns?: string // for SVGs\n    fn?: () => VNode // for thunks\n    args?: any[] // for thunks\n    [key: string]: any // for any other 3rd party module\n}\n\nexport type Key = string | number\n\nconst interface VNode = {\n    sel: string | undefined, // 选择器\n    data: VNodeData | undefined, // VNodeData上面定义的VNodeData\n    children: Array<VNode | string> | undefined, //子节点,与text互斥\n    text: string | undefined, // 标签中间的文本内容\n    elm: Node | undefined, // 转换而成的真实DOM\n    key: Key | undefined // 字符串或者数字\n}\n\n复制代码\n")])])]),n("h5",{attrs:{id:"补充"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#补充"}},[e._v("#")]),e._v(" 补充:")]),e._v(" "),n("p",[e._v("上面的h函数大家可能有点熟悉的感觉但是一时间也没想起来,没关系我来帮大伙回忆; "),n("code",[e._v("开发中常见的现实场景,render函数渲染")]),e._v(":")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("// 案例1 vue项目中的main.js的创建vue实例\nnew Vue({\n  router,\n  store,\n  render: h => h(App)\n}).$mount(\"#app\");\n\n//案例2 列表中使用render渲染\ncolumns: [\n    {\n        title: \"操作\",\n        key: \"action\",\n        width: 150,\n        render: (h, params) => {\n            return h('div', [\n                h('Button', {\n                    props: {\n                        size: 'small'\n                    },\n                    style: {\n                        marginRight: '5px',\n                        marginBottom: '5px',\n                    },\n                    on: {\n                        click: () => {\n                            this.toEdit(params.row.uuid);\n                        }\n                    }\n                }, '编辑')\n            ]);\n        }\n    }\n]\n复制代码\n")])])]),n("hr"),e._v(" "),n("h3",{attrs:{id:"为什么要使用虚拟dom"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#为什么要使用虚拟dom"}},[e._v("#")]),e._v(" 为什么要使用虚拟DOM")]),e._v(" "),n("ul",[n("li",[n("p",[e._v("MVVM框架解决视图和状态同步问题")])]),e._v(" "),n("li",[n("p",[e._v("模板引擎可以简化视图操作,没办法跟踪状态")])]),e._v(" "),n("li",[n("p",[e._v("虚拟DOM跟踪状态变化")])]),e._v(" "),n("li",[n("p",[e._v("参考github上"),n("strong",[e._v("virtual-dom")]),e._v("[1]的动机描述")])]),e._v(" "),n("li",[n("ul",[n("li",[e._v("虚拟DOM可以维护程序的状态,跟踪上一次的状态")]),e._v(" "),n("li",[e._v("通过比较前后两次状态差异更新真实DOM")])])]),e._v(" "),n("li",[n("p",[e._v("跨平台使用")])]),e._v(" "),n("li",[n("ul",[n("li",[e._v("浏览器平台渲染DOM")]),e._v(" "),n("li",[e._v("服务端渲染SSR(Nuxt.js/Next.js),前端是vue向,后者是react向")]),e._v(" "),n("li",[e._v("原生应用(Weex/React Native)")]),e._v(" "),n("li",[e._v("小程序(mpvue/uni-app)等")])])]),e._v(" "),n("li",[n("p",[e._v("真实DOM的属性很多，创建DOM节点开销很大")])]),e._v(" "),n("li",[n("p",[e._v("虚拟DOM只是普通JavaScript对象，描述属性并不需要很多，创建开销很小")])]),e._v(" "),n("li",[n("p",[n("strong",[e._v("复杂视图情况下提升渲染性能")]),e._v("(操作dom性能消耗大,减少操作dom的范围可以提升性能)")])])]),e._v(" "),n("p",[n("strong",[e._v("灵魂发问")]),e._v(":使用了虚拟DOM就一定会比直接渲染真实DOM快吗?答案当然是"),n("code",[e._v("否定")]),e._v("的,且听我说:"),n("img",{attrs:{src:"https://mmbiz.qpic.cn/sz_mmbiz_jpg/H8M5QJDxMHrBPOs1OFIWuxw354WxNWGLOqRQpVxXrpsrQicImZicauU14gEaQsytr9ctPwnribnp8RumzfVibLJ5TA/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}})]),e._v(" "),n("p",[n("strong",[e._v("举例")]),e._v(":当一个节点变更时DOMA->DOMB")]),e._v(" "),n("p",[n("img",{attrs:{src:"https://mmbiz.qpic.cn/sz_mmbiz_png/H8M5QJDxMHrBPOs1OFIWuxw354WxNWGLMicqWYBn2NDILaboY0599tJPkaaOl2fJKJIScBrdjmUcGP20MxJgmRQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}}),e._v("上述情况: "),n("code",[e._v("示例1")]),e._v("是创建一个"),n("code",[e._v("DOMB")]),e._v("然后替换掉"),n("code",[e._v("DOMA")]),e._v("; "),n("code",[e._v("示例2")]),e._v("去"),n("code",[e._v("创建虚拟DOM+DIFF算法")]),e._v("比对发现"),n("code",[e._v("DOMB")]),e._v("跟"),n("code",[e._v("DOMA")]),e._v("不是相同的节点,最后还是创建一个"),n("code",[e._v("DOMB")]),e._v("然后替换掉"),n("code",[e._v("DOMA")]),e._v("; 可以明显看出1是更快的,同样的结果,2还要去创建虚拟DOM+DIFF算啊对比 所以说使用虚拟DOM比直接操作真实DOM就一定要快这个说法是"),n("code",[e._v("错误的,不严谨的")])]),e._v(" "),n("p",[n("strong",[e._v("举例")]),e._v(":当DOM树里面的某个子节点的内容变更时:")]),e._v(" "),n("p",[n("img",{attrs:{src:"https://mmbiz.qpic.cn/sz_mmbiz_png/H8M5QJDxMHrBPOs1OFIWuxw354WxNWGLawXVuJrQgyv2RIt2c8XXFPADLfbDMJ55ibzBib36sAbTLXv6Qgg2sySQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}}),e._v("当一些复杂的节点,比如说一个父节点里面有多个子节点,当只是一个子节点的内容发生了改变,那么我们没有必要像"),n("code",[e._v("示例1")]),e._v("重新去渲染这个"),n("code",[e._v("DOM树")]),e._v(",这个时候"),n("code",[e._v("虚拟DOM+DIFF算法")]),e._v("就能够得到很好的体现,我们通过"),n("code",[e._v("示例2")]),e._v("使用"),n("code",[e._v("虚拟DOM+Diff算法")]),e._v("去找出改变了的子节点更新它的内容就可以了")]),e._v(" "),n("p",[e._v("总结:"),n("strong",[e._v("复杂视图情况下提升渲染性能")]),e._v(",因为"),n("code",[e._v("虚拟DOM+Diff算法")]),e._v("可以精准找到DOM树变更的地方,减少DOM的操作(重排重绘)")]),e._v(" "),n("hr"),e._v(" "),n("h3",{attrs:{id:"虚拟dom库"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#虚拟dom库"}},[e._v("#")]),e._v(" 虚拟dom库")]),e._v(" "),n("ul",[n("li",[n("p",[n("strong",[e._v("Snabbdom")]),e._v("[2]")])]),e._v(" "),n("li",[n("ul",[n("li",[e._v("Vue.js2.x内部使用的虚拟DOM就是改造的Snabbdom")]),e._v(" "),n("li",[e._v("大约200SLOC(single line of code)")]),e._v(" "),n("li",[e._v("通过模块可扩展")]),e._v(" "),n("li",[e._v("源码使用TypeScript开发")]),e._v(" "),n("li",[e._v("最快的Virtual DOM之一")])])]),e._v(" "),n("li",[n("p",[n("strong",[e._v("virtual-dom")]),e._v("[3]")])])]),e._v(" "),n("hr"),e._v(" "),n("h2",{attrs:{id:"diff算法"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#diff算法"}},[e._v("#")]),e._v(" Diff算法")]),e._v(" "),n("p",[e._v("在看完上述的文章之后相信大家已经对Diff算法有一个初步的概念,没错,Diff算法其实就是找出两者之间的差异;")]),e._v(" "),n("blockquote",[n("p",[e._v("diff 算法首先要明确一个概念就是 Diff 的对象是虚拟DOM（virtual dom），更新真实 DOM 是 Diff 算法的结果。")])]),e._v(" "),n("p",[e._v("下面我将会手撕"),n("code",[e._v("snabbdom")]),e._v("源码核心部分为大家打开"),n("code",[e._v("Diff")]),e._v("的心,给点耐心,别关网页,我知道你们都是这样:")]),e._v(" "),n("p",[n("img",{attrs:{src:"https://mmbiz.qpic.cn/sz_mmbiz_jpg/H8M5QJDxMHrBPOs1OFIWuxw354WxNWGLmiaaGkkBAmSsUpkaFzPL6DXA5wPrSePTiajHt6GbtZjs6gQvdRUlhwdA/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}}),e._v("src=http___img.wxcha.com_file_201905_17_f5a4d33d48.jpg&refer=http___img.wxcha.jpeg")]),e._v(" "),n("hr"),e._v(" "),n("h2",{attrs:{id:"snabbdom的核心"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#snabbdom的核心"}},[e._v("#")]),e._v(" snabbdom的核心")]),e._v(" "),n("ul",[n("li",[n("code",[e._v("init()")]),e._v("设置模块.创建"),n("code",[e._v("patch()")]),e._v("函数")]),e._v(" "),n("li",[e._v("使用"),n("code",[e._v("h()")]),e._v("函数创建JavaScript对象"),n("code",[e._v("(Vnode)")]),e._v("描述"),n("code",[e._v("真实DOM")])]),e._v(" "),n("li",[n("code",[e._v("patch()")]),e._v("比较"),n("code",[e._v("新旧两个Vnode")])]),e._v(" "),n("li",[e._v("把变化的内容更新到"),n("code",[e._v("真实DOM树")])])]),e._v(" "),n("h3",{attrs:{id:"init函数"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#init函数"}},[e._v("#")]),e._v(" init函数")]),e._v(" "),n("p",[e._v("init函数时设置模块,然后创建patch()函数,我们先通过场景案例来有一个直观的体现:")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("import {init} from 'snabbdom/build/package/init.js'\nimport {h} from 'snabbdom/build/package/h.js'\n\n// 1.导入模块\nimport {styleModule} from \"snabbdom/build/package/modules/style\";\nimport {eventListenersModule} from \"snabbdom/build/package/modules/eventListeners\";\n\n// 2.注册模块\nconst patch = init([\n  styleModule,\n  eventListenersModule\n])\n\n// 3.使用h()函数的第二个参数传入模块中使用的数据(对象)\nlet vnode = h('div', [\n  h('h1', {style: {backgroundColor: 'red'}}, 'Hello world'),\n  h('p', {on: {click: eventHandler}}, 'Hello P')\n])\n\nfunction eventHandler() {\n  alert('疼,别摸我')\n}\n\nconst app = document.querySelector('#app')\n\npatch(app,vnode)\n复制代码\n")])])]),n("p",[e._v("当init使用了导入的模块就能够在h函数中用这些模块提供的api去创建"),n("code",[e._v("虚拟DOM(Vnode)对象")]),e._v(";在上文中就使用了"),n("code",[e._v("样式模块")]),e._v("以及"),n("code",[e._v("事件模块")]),e._v("让创建的这个虚拟DOM具备样式属性以及事件属性,最终通过"),n("code",[e._v("patch函数")]),e._v("对比"),n("code",[e._v("两个虚拟dom")]),e._v("(会先把app转换成虚拟dom),更新视图;")]),e._v(" "),n("p",[n("img",{attrs:{src:"https://mmbiz.qpic.cn/sz_mmbiz_png/H8M5QJDxMHrBPOs1OFIWuxw354WxNWGLaFBls2pciaaK7XfSjuKBuTicUq5wUUmX7tF5BSPF0Hr8bruzUMSjt3Tw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}}),e._v("image.png")]),e._v(" "),n("p",[e._v("我们再简单看看init的源码部分:")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("// src/package/init.ts\n/* 第一参数就是各个模块\n   第二参数就是DOMAPI,可以把DOM转换成别的平台的API,\n也就是说支持跨平台使用,当不传的时候默认是htmlDOMApi,见下文\n   init是一个高阶函数,一个函数返回另外一个函数,可以缓存modules,与domApi两个参数,\n那么以后直接只传oldValue跟newValue(vnode)就可以了*/\nexport function init (modules: Array<Partial<Module>>, domApi?: DOMAPI) {\n\n...\n\nreturn function patch (oldVnode: VNode | Element, vnode: VNode): VNode {}\n}\n复制代码\n")])])]),n("hr"),e._v(" "),n("h3",{attrs:{id:"h函数"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#h函数"}},[e._v("#")]),e._v(" h函数")]),e._v(" "),n("p",[e._v("些地方也会用"),n("code",[e._v("createElement")]),e._v("来命名,它们是一样的东西,都是创建"),n("code",[e._v("虚拟DOM")]),e._v("的,在上述文章中相信大伙已经对h函数有一个初步的了解并且已经联想了使用场景,就不作场景案例介绍了,直接上源码部分:")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("// h函数\nexport function h (sel: string): VNode\nexport function h (sel: string, data: VNodeData | null): VNode\nexport function h (sel: string, children: VNodeChildren): VNode\nexport function h (sel: string, data: VNodeData | null, children: VNodeChildren): VNode\nexport function h (sel: any, b?: any, c?: any): VNode {\n  var data: VNodeData = {}\n  var children: any\n  var text: any\n  var i: number\n    ...\n  return vnode(sel, data, children, text, undefined) //最终返回一个vnode函数\n};\n复制代码\n// vnode函数\nexport function vnode (sel: string | undefined,\n  data: any | undefined,\n  children: Array<VNode | string> | undefined,\n  text: string | undefined,\n  elm: Element | Text | undefined): VNode {\n  const key = data === undefined ? undefined : data.key\n  return { sel, data, children, text, elm, key } //最终生成Vnode对象\n}\n复制代码\n")])])]),n("p",[n("strong",[e._v("总结")]),e._v(":"),n("code",[e._v("h函数")]),e._v("先生成一个"),n("code",[e._v("vnode")]),e._v("函数,然后"),n("code",[e._v("vnode")]),e._v("函数再生成一个"),n("code",[e._v("Vnode")]),e._v("对象(虚拟DOM对象)")]),e._v(" "),n("h4",{attrs:{id:"补充-2"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#补充-2"}},[e._v("#")]),e._v(" 补充:")]),e._v(" "),n("p",[e._v("在h函数源码部分涉及一个"),n("code",[e._v("函数重载")]),e._v("的概念,简单说明一下:")]),e._v(" "),n("ul",[n("li",[e._v("参数个数或参数类型不同的函数()")]),e._v(" "),n("li",[e._v("JavaScript中没有重载的概念")]),e._v(" "),n("li",[e._v("TypeScript中有重载,不过重载的实现还是通过代码调整参数")])]),e._v(" "),n("blockquote",[n("p",[e._v("重载这个概念个参数相关,和返回值无关")])]),e._v(" "),n("ul",[n("li",[e._v("实例1(函数重载-参数个数)")])]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("function add(a:number,b:number){\n\nconsole.log(a+b)\n\n}\n\nfunction add(a:number,b:number,c:number){\n\nconsole.log(a+b+c)\n\n}\n\nadd(1,2)\n\nadd(1,2,3)\n\n复制代码\n")])])]),n("ul",[n("li",[e._v("实例2(函数重载-参数类型)")])]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("function add(a:number,b:number){\n\nconsole.log(a+b)\n\n}\n\nfunction add(a:number,b:string){\n\nconsole.log(a+b)\n\n}\n\nadd(1,2)\n\nadd(1,'2')\n\n复制代码\n")])])]),n("hr"),e._v(" "),n("h3",{attrs:{id:"patch函数-核心"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#patch函数-核心"}},[e._v("#")]),e._v(" patch函数(核心)")]),e._v(" "),n("p",[n("img",{attrs:{src:"https://mmbiz.qpic.cn/sz_mmbiz_jpg/H8M5QJDxMHrBPOs1OFIWuxw354WxNWGLdMiaEDJ8ZsO8A93InplfPM97XWqSnm6Y3nLH4QwOdVyqrwpVvJP5VJg/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}}),e._v("src=http___shp.qpic.cn_qqvideo_ori_0_e3012t7v643_496_280_0&refer=http___shp.qpic.jpeg")]),e._v(" "),n("p",[e._v("要是看完前面的铺垫,看到这里你可能走神了,"),n("code",[e._v("醒醒啊,这是核心啊,上高地了兄弟")]),e._v(";")]),e._v(" "),n("ul",[n("li",[e._v("pactch(oldVnode,newVnode)")]),e._v(" "),n("li",[e._v("把新节点中变化的内容渲染到真实DOM,最后返回新节点作为下一次处理的旧节点(核心)")]),e._v(" "),n("li",[e._v("对比新旧"),n("code",[e._v("VNode")]),e._v("是否相同节点(节点的key和sel相同)")]),e._v(" "),n("li",[e._v("如果不是相同节点,删除之前的内容,重新渲染")]),e._v(" "),n("li",[e._v("如果是相同节点,再判断新的"),n("code",[e._v("VNode")]),e._v("是否有"),n("code",[e._v("text")]),e._v(",如果有并且和"),n("code",[e._v("oldVnode")]),e._v("的"),n("code",[e._v("text")]),e._v("不同直接更新文本内容"),n("code",[e._v("(patchVnode)")])]),e._v(" "),n("li",[e._v("如果新的VNode有children,判断子节点是否有变化"),n("code",[e._v("(updateChildren,最麻烦,最难实现)")])])]),e._v(" "),n("p",[e._v("源码:")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("return function patch(oldVnode: VNode | Element, vnode: VNode): VNode {    \n    let i: number, elm: Node, parent: Node\n    const insertedVnodeQueue: VNodeQueue = []\n    // cbs.pre就是所有模块的pre钩子函数集合\n    for (i = 0; i < cbs.pre.length; ++i) cbs.pre[i]()\n    // isVnode函数时判断oldVnode是否是一个虚拟DOM对象\n    if (!isVnode(oldVnode)) {\n        // 若不是即把Element转换成一个虚拟DOM对象\n        oldVnode = emptyNodeAt(oldVnode)\n    }\n    // sameVnode函数用于判断两个虚拟DOM是否是相同的,源码见补充1;\n    if (sameVnode(oldVnode, vnode)) {\n        // 相同则运行patchVnode对比两个节点,关于patchVnode后面会重点说明(核心)\n        patchVnode(oldVnode, vnode, insertedVnodeQueue)\n    } else {\n        elm = oldVnode.elm! // !是ts的一种写法代码oldVnode.elm肯定有值\n        // parentNode就是获取父元素\n        parent = api.parentNode(elm) as Node\n\n        // createElm是用于创建一个dom元素插入到vnode中(新的虚拟DOM)\n        createElm(vnode, insertedVnodeQueue)\n\n        if (parent !== null) {\n            // 把dom元素插入到父元素中,并且把旧的dom删除\n            api.insertBefore(parent, vnode.elm!, api.nextSibling(elm))// 把新创建的元素放在旧的dom后面\n            removeVnodes(parent, [oldVnode], 0, 0)\n        }\n    }\n\n    for (i = 0; i < insertedVnodeQueue.length; ++i) {\n        insertedVnodeQueue[i].data!.hook!.insert!(insertedVnodeQueue[i])\n    }\n    for (i = 0; i < cbs.post.length; ++i) cbs.post[i]()\n    return vnode\n}\n复制代码\n")])])]),n("h4",{attrs:{id:"补充1-samevnode函数"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#补充1-samevnode函数"}},[e._v("#")]),e._v(" 补充1: sameVnode函数")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("function sameVnode(vnode1: VNode, vnode2: VNode): boolean { 通过key和sel选择器判断是否是相同节点\n    return vnode1.key === vnode2.key && vnode1.sel === vnode2.sel\n}\n复制代码\n")])])]),n("hr"),e._v(" "),n("h3",{attrs:{id:"patchvnode"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#patchvnode"}},[e._v("#")]),e._v(" patchVnode")]),e._v(" "),n("ul",[n("li",[e._v("第一阶段触发"),n("code",[e._v("prepatch")]),e._v("函数以及"),n("code",[e._v("update")]),e._v("函数(都会触发prepatch函数,两者不完全相同才会触发update函数)")]),e._v(" "),n("li",[e._v("第二阶段,真正对比新旧"),n("code",[e._v("vnode")]),e._v("差异的地方")]),e._v(" "),n("li",[e._v("第三阶段,触发"),n("code",[e._v("postpatch")]),e._v("函数更新节点")])]),e._v(" "),n("p",[e._v("源码:")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("function patchVnode(oldVnode: VNode, vnode: VNode, insertedVnodeQueue: VNodeQueue) {\n    const hook = vnode.data?.hook\n    hook?.prepatch?.(oldVnode, vnode)\n    const elm = vnode.elm = oldVnode.elm!\n    const oldCh = oldVnode.children as VNode[]\n    const ch = vnode.children as VNode[]\n    if (oldVnode === vnode) return\n    if (vnode.data !== undefined) {\n        for (let i = 0; i < cbs.update.length; ++i) cbs.update[i](oldVnode, vnode)\n        vnode.data.hook?.update?.(oldVnode, vnode)\n    }\n    if (isUndef(vnode.text)) { // 新节点的text属性是undefined\n        if (isDef(oldCh) && isDef(ch)) { // 当新旧节点都存在子节点\n            if (oldCh !== ch) updateChildren(elm, oldCh, ch, insertedVnodeQueue) //并且他们的子节点不相同执行updateChildren函数,后续会重点说明(核心)\n        } else if (isDef(ch)) { // 只有新节点有子节点\n            // 当旧节点有text属性就会把''赋予给真实dom的text属性\n            if (isDef(oldVnode.text)) api.setTextContent(elm, '') \n            // 并且把新节点的所有子节点插入到真实dom中\n            addVnodes(elm, null, ch, 0, ch.length - 1, insertedVnodeQueue)\n        } else if (isDef(oldCh)) { // 清除真实dom的所有子节点\n            removeVnodes(elm, oldCh, 0, oldCh.length - 1)\n        } else if (isDef(oldVnode.text)) { // 把''赋予给真实dom的text属性\n            api.setTextContent(elm, '')\n        }\n    } else if (oldVnode.text !== vnode.text) { //若旧节点的text与新节点的text不相同\n        if (isDef(oldCh)) { // 若旧节点有子节点,就把所有的子节点删除\n            removeVnodes(elm, oldCh, 0, oldCh.length - 1)\n        }\n        api.setTextContent(elm, vnode.text!) // 把新节点的text赋予给真实dom\n    }\n    hook?.postpatch?.(oldVnode, vnode) // 更新视图\n}\n复制代码\n")])])]),n("p",[e._v("看得可能有点蒙蔽,下面再上一副思维导图:")]),e._v(" "),n("p",[n("img",{attrs:{src:"https://mmbiz.qpic.cn/sz_mmbiz_png/H8M5QJDxMHrBPOs1OFIWuxw354WxNWGLHNVic3kCtibTYFxoJKuJxNsibX6CrbylKsKXUUoWAwAXfyxSCapNOJJUw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}}),e._v("image.png")]),e._v(" "),n("hr"),e._v(" "),n("h3",{attrs:{id:"题外话-diff算法简介"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#题外话-diff算法简介"}},[e._v("#")]),e._v(" 题外话:diff算法简介")]),e._v(" "),n("p",[n("strong",[e._v("传统diff算法")])]),e._v(" "),n("ul",[n("li",[e._v("虚拟DOM中的Diff算法")]),e._v(" "),n("li",[n("code",[e._v("传统算法")]),e._v("查找两颗树每一个节点的差异")]),e._v(" "),n("li",[e._v("会运行n1(dom1的节点数)*n2(dom2的节点数)次方去对比,找到差异的部分再去更新")])]),e._v(" "),n("p",[n("img",{attrs:{src:"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==",alt:"图片"}}),e._v("image.png")]),e._v(" "),n("p",[n("strong",[e._v("snabbdom的diff算法优化")])]),e._v(" "),n("ul",[n("li",[e._v("Snbbdom根据DOM的特点对传统的diff算法做了"),n("code",[e._v("优化")])]),e._v(" "),n("li",[e._v("DOM操作时候很少会跨级别操作节点")]),e._v(" "),n("li",[e._v("只比较"),n("code",[e._v("同级别")]),e._v("的节点")])]),e._v(" "),n("p",[n("img",{attrs:{src:"https://mmbiz.qpic.cn/sz_mmbiz_png/H8M5QJDxMHrBPOs1OFIWuxw354WxNWGLhTt5D51vDv7tKQJxPMIoJBiaZVnGVEyulmeDO6XoaOgg0wcAcfib0huw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}}),e._v("image.png")]),e._v(" "),n("p",[n("img",{attrs:{src:"https://mmbiz.qpic.cn/sz_mmbiz_jpg/H8M5QJDxMHrBPOs1OFIWuxw354WxNWGLPiclzDgbxv9NeLzmfvHlj8c4nG4GyIC5ibnxSxj9iaAIibvQy6ic8kDcUdw/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}}),e._v("src=http___img.wxcha.com_file_202004_03_1ed2e19e4f.jpg&refer=http___img.wxcha.jpeg")]),e._v(" "),n("p",[e._v("下面我们就会介绍"),n("code",[e._v("updateChildren")]),e._v("函数怎么去对比子节点的"),n("code",[e._v("异同")]),e._v(",也是"),n("code",[e._v("Diff算法")]),e._v("里面的一个核心以及难点;")]),e._v(" "),n("hr"),e._v(" "),n("h3",{attrs:{id:"updatechildren-核中核-判断子节点的差异"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#updatechildren-核中核-判断子节点的差异"}},[e._v("#")]),e._v(" updateChildren(核中核:判断子节点的差异)")]),e._v(" "),n("ul",[n("li",[e._v("这个函数我分为三个部分,"),n("code",[e._v("部分1:声明变量")]),e._v(","),n("code",[e._v("部分2:同级别节点比较")]),e._v(","),n("code",[e._v("部分3:循环结束的收尾工作")]),e._v("(见下图);")])]),e._v(" "),n("p",[n("img",{attrs:{src:"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==",alt:"图片"}}),e._v("image.png")]),e._v(" "),n("ul",[n("li",[n("p",[n("code",[e._v("同级别节点比较")]),e._v("的"),n("code",[e._v("五种")]),e._v("情况:")])]),e._v(" "),n("li",[n("ol",[n("li",[n("code",[e._v("oldStartVnode/newStartVnode")]),e._v("(旧开始节点/新开始节点)相同")]),e._v(" "),n("li",[n("code",[e._v("oldEndVnode/newEndVnode")]),e._v("(旧结束节点/新结束节点)相同")]),e._v(" "),n("li",[n("code",[e._v("oldStartVnode/newEndVnode")]),e._v("(旧开始节点/新结束节点)相同")]),e._v(" "),n("li",[n("code",[e._v("oldEndVnode/newStartVnode")]),e._v("(旧结束节点/新开始节点)相同")]),e._v(" "),n("li",[n("code",[e._v("特殊情况当1,2,3,4的情况都不符合")]),e._v("的时候就会执行,在"),n("code",[e._v("oldVnodes")]),e._v("里面寻找跟"),n("code",[e._v("newStartVnode")]),e._v("一样的节点然后位移到"),n("code",[e._v("oldStartVnode")]),e._v(",若没有找到在就"),n("code",[e._v("oldStartVnode")]),e._v("创建一个")])])]),e._v(" "),n("li",[n("p",[e._v("执行过程是一个循环,在每次循环里,只要执行了上述的情况的五种之一就会结束一次循环")])]),e._v(" "),n("li",[n("p",[n("code",[e._v("循环结束的收尾工作")]),e._v(":直到oldStartIdx>oldEndIdx || newStartIdx>newEndIdx(代表旧节点或者新节点已经遍历完)")])])]),e._v(" "),n("p",[e._v("为了更加直观的了解,我们再来看看"),n("code",[e._v("同级别节点比较")]),e._v("的"),n("code",[e._v("五种")]),e._v("情况的实现细节:")]),e._v(" "),n("h4",{attrs:{id:"新开始节点和旧开始节点-情况1"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#新开始节点和旧开始节点-情况1"}},[e._v("#")]),e._v(" 新开始节点和旧开始节点(情况1)")]),e._v(" "),n("p",[n("img",{attrs:{src:"https://mmbiz.qpic.cn/sz_mmbiz_png/H8M5QJDxMHrBPOs1OFIWuxw354WxNWGL0FukiaVosSclGTu0CVmzFnDl25vU2xDfGFqrdib1ApyMxbicfJHU7hxoQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}}),e._v("image.png")]),e._v(" "),n("ul",[n("li",[e._v("若"),n("code",[e._v("情况1符合:(从新旧节点的开始节点开始对比")]),e._v(","),n("code",[e._v("oldCh[oldStartIdx]和newCh[newStartIdx]")]),e._v("进行"),n("code",[e._v("sameVnode(key和sel相同)")]),e._v("判断是否相同节点)")]),e._v(" "),n("li",[e._v("则执行"),n("code",[e._v("patchVnode")]),e._v("找出两者之间的差异,更新图;如没有差异则什么都不操作,结束一次循环")]),e._v(" "),n("li",[n("code",[e._v("oldStartIdx++/newStartIdx++")])])]),e._v(" "),n("h4",{attrs:{id:"新结束节点和旧结束节点-情况2"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#新结束节点和旧结束节点-情况2"}},[e._v("#")]),e._v(" 新结束节点和旧结束节点(情况2)")]),e._v(" "),n("p",[n("img",{attrs:{src:"https://mmbiz.qpic.cn/sz_mmbiz_png/H8M5QJDxMHrBPOs1OFIWuxw354WxNWGLVLrlUWMxPpwEeGcyyqNlav4kQ39b67C6udVcSBVQMUCbJ2cQuy2Mrw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}}),e._v("image.png")]),e._v(" "),n("ul",[n("li",[e._v("若"),n("code",[e._v("情况1不符合")]),e._v("就判断"),n("code",[e._v("情况2")]),e._v(",若符合:(从新旧节点的结束节点开始对比,"),n("code",[e._v("oldCh[oldEndIdx]和newCh[newEndIdx]")]),e._v("对比,执行"),n("code",[e._v("sameVnode(key和sel相同)")]),e._v("判断是否相同节点)")]),e._v(" "),n("li",[e._v("执行"),n("code",[e._v("patchVnode")]),e._v("找出两者之间的差异,更新视图,;如没有差异则什么都不操作,结束一次循环")]),e._v(" "),n("li",[n("code",[e._v("oldEndIdx--/newEndIdx--")])])]),e._v(" "),n("h4",{attrs:{id:"旧开始节点-新结束节点-情况3"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#旧开始节点-新结束节点-情况3"}},[e._v("#")]),e._v(" 旧开始节点/新结束节点(情况3)")]),e._v(" "),n("p",[n("img",{attrs:{src:"https://mmbiz.qpic.cn/sz_mmbiz_png/H8M5QJDxMHrBPOs1OFIWuxw354WxNWGLZVArY457qurQ68lYhlOoMwPsP0MH6vwhmCCqbkFA9UticROnNkicLHMw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}}),e._v("image.png")]),e._v(" "),n("ul",[n("li",[e._v("若"),n("code",[e._v("情况1,2")]),e._v("都不符合,就会尝试情况3:(旧节点的开始节点与新节点的结束节点开始对比,"),n("code",[e._v("oldCh[oldStartIdx]和newCh[newEndIdx]")]),e._v("对比,执行"),n("code",[e._v("sameVnode(key和sel相同)")]),e._v("判断是否相同节点)")]),e._v(" "),n("li",[e._v("执行"),n("code",[e._v("patchVnode")]),e._v("找出两者之间的差异,更新视图,如没有差异则什么都不操作,结束一次循环")]),e._v(" "),n("li",[n("code",[e._v("oldCh[oldStartIdx]对应的真实dom")]),e._v("位移到"),n("code",[e._v("oldCh[oldEndIdx]对应的真实dom")]),e._v("后")]),e._v(" "),n("li",[n("code",[e._v("oldStartIdx++/newEndIdx--")]),e._v(";")])]),e._v(" "),n("h4",{attrs:{id:"旧结束节点-新开始节点-情况4"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#旧结束节点-新开始节点-情况4"}},[e._v("#")]),e._v(" 旧结束节点/新开始节点(情况4)")]),e._v(" "),n("p",[n("img",{attrs:{src:"https://mmbiz.qpic.cn/sz_mmbiz_png/H8M5QJDxMHrBPOs1OFIWuxw354WxNWGLrSn8AFYYhe5PkXz3mvF8vmlgMIVWMib7ia6M8RPLiaF0icOjecqDARRQrw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}}),e._v("image.png")]),e._v(" "),n("ul",[n("li",[e._v("若"),n("code",[e._v("情况1,2,3")]),e._v("都不符合,就会尝试情况4:(旧节点的结束节点与新节点的开始节点开始对比,"),n("code",[e._v("oldCh[oldEndIdx]和newCh[newStartIdx]")]),e._v("对比,执行"),n("code",[e._v("sameVnode(key和sel相同)")]),e._v("判断是否相同节点)")]),e._v(" "),n("li",[e._v("执行"),n("code",[e._v("patchVnode")]),e._v("找出两者之间的差异,更新视图,如没有差异则什么都不操作,结束一次循环")]),e._v(" "),n("li",[n("code",[e._v("oldCh[oldEndIdx]对应的真实dom")]),e._v("位移到"),n("code",[e._v("oldCh[oldStartIdx]对应的真实dom")]),e._v("前")]),e._v(" "),n("li",[n("code",[e._v("oldEndIdx--/newStartIdx++")]),e._v(";")])]),e._v(" "),n("h4",{attrs:{id:"新开始节点-旧节点数组中寻找节点-情况5"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#新开始节点-旧节点数组中寻找节点-情况5"}},[e._v("#")]),e._v(" 新开始节点/旧节点数组中寻找节点(情况5)")]),e._v(" "),n("p",[n("img",{attrs:{src:"https://mmbiz.qpic.cn/sz_mmbiz_png/H8M5QJDxMHrBPOs1OFIWuxw354WxNWGLDfkGugZlWV20ibb28fccQYyfnVQrKRkbI0OhQk7YWMfzGa2lhRZiatYQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}}),e._v("image.png")]),e._v(" "),n("ul",[n("li",[e._v("从旧节点里面寻找,若寻找到与"),n("code",[e._v("newCh[newStartIdx]")]),e._v("相同的节点(且叫"),n("code",[e._v("对应节点[1]")]),e._v("),执行"),n("code",[e._v("patchVnode")]),e._v("找出两者之间的差异,更新视图,如没有差异则什么都不操作,结束一次循环")]),e._v(" "),n("li",[n("code",[e._v("对应节点[1]对应的真实dom")]),e._v("位移到"),n("code",[e._v("oldCh[oldStartIdx]对应的真实dom")]),e._v("前")])]),e._v(" "),n("p",[n("img",{attrs:{src:"https://mmbiz.qpic.cn/sz_mmbiz_png/H8M5QJDxMHrBPOs1OFIWuxw354WxNWGLH3WaEve0S2DSdgSNRG7ZD6wEvRbGkXZzGx1MkprolMTtTzbW9UdeSg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}}),e._v("image.png")]),e._v(" "),n("ul",[n("li",[n("code",[e._v("若没有寻找到相同的节点")]),e._v(",则创建一个与"),n("code",[e._v("newCh[newStartIdx]")]),e._v("节点对应的"),n("code",[e._v("真实dom")]),e._v("插入到"),n("code",[e._v("oldCh[oldStartIdx]对应的真实dom")]),e._v("前")]),e._v(" "),n("li",[n("code",[e._v("newStartIdx++")])])]),e._v(" "),n("p",[n("img",{attrs:{src:"https://mmbiz.qpic.cn/sz_mmbiz_jpg/H8M5QJDxMHrBPOs1OFIWuxw354WxNWGLzpq1l65ibHAOJ2cmVFjzribYZmcS4tEFAO9Y7vLvum5w6PtZic5Fve3Fw/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}}),e._v("379426071b8130075b11ba142f9468e2.jpeg")]),e._v(" "),n("hr"),e._v(" "),n("p",[e._v("下面我们再介绍一下"),n("code",[e._v("结束循环")]),e._v("的收尾工作"),n("code",[e._v("(oldStartIdx>oldEndIdx || newStartIdx>newEndIdx)")]),e._v(":")]),e._v(" "),n("p",[n("img",{attrs:{src:"https://mmbiz.qpic.cn/sz_mmbiz_png/H8M5QJDxMHrBPOs1OFIWuxw354WxNWGLmYk2PhgcCYDS65VF1IO40oePD81kk9mnXtEGzmFRSz6twwVHPNRYYQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}}),e._v("image.png")]),e._v(" "),n("ul",[n("li",[n("code",[e._v("新节点的所有子节点")]),e._v("先遍历完("),n("code",[e._v("newStartIdx>newEndIdx")]),e._v("),循环结束")]),e._v(" "),n("li",[n("code",[e._v("新节点的所有子节点")]),e._v("遍历结束就是把没有对应相同节点的"),n("code",[e._v("子节点")]),e._v("删除")])]),e._v(" "),n("p",[n("img",{attrs:{src:"https://mmbiz.qpic.cn/sz_mmbiz_png/H8M5QJDxMHrBPOs1OFIWuxw354WxNWGLxpzF89kARG0zoXdXQXupc0PXWK4SyBSUib2vyLlemRV1zNHiaYRXpoDA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}}),e._v("image.png")]),e._v(" "),n("ul",[n("li",[n("code",[e._v("旧节点的所有子节点")]),e._v("先遍历完("),n("code",[e._v("oldStartIdx>oldEndIdx")]),e._v("),循环结束")]),e._v(" "),n("li",[n("code",[e._v("旧节点的所有子节点")]),e._v("遍历结束就是在多出来的"),n("code",[e._v("子节点")]),e._v("插入到"),n("code",[e._v("旧节点结束节点")]),e._v("前;(源码:"),n("code",[e._v("newCh[newEndIdx + 1].elm)")]),e._v(",就是对应的"),n("code",[e._v("旧结束节点的真实dom")]),e._v(",newEndIdx+1是因为在匹配到相同的节点需要-1,所以需要加回来就是结束节点")])]),e._v(" "),n("p",[e._v("最后附上源码:")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("function updateChildren(parentElm, oldCh, newCh, insertedVnodeQueue) {\n    let oldStartIdx = 0;                // 旧节点开始节点索引\n    let newStartIdx = 0;                // 新节点开始节点索引\n    let oldEndIdx = oldCh.length - 1;   // 旧节点结束节点索引\n    let oldStartVnode = oldCh[0];       // 旧节点开始节点\n    let oldEndVnode = oldCh[oldEndIdx]; // 旧节点结束节点\n    let newEndIdx = newCh.length - 1;   // 新节点结束节点索引\n    let newStartVnode = newCh[0];       // 新节点开始节点\n    let newEndVnode = newCh[newEndIdx]; // 新节点结束节点\n    let oldKeyToIdx;                    // 节点移动相关\n    let idxInOld;                       // 节点移动相关\n    let elmToMove;                      // 节点移动相关\n    let before;\n\n\n    // 同级别节点比较\n    while (oldStartIdx <= oldEndIdx && newStartIdx <= newEndIdx) {\n        if (oldStartVnode == null) {\n            oldStartVnode = oldCh[++oldStartIdx]; // Vnode might have been moved left\n        }\n        else if (oldEndVnode == null) {\n            oldEndVnode = oldCh[--oldEndIdx];\n        }\n        else if (newStartVnode == null) {\n            newStartVnode = newCh[++newStartIdx];\n        }\n        else if (newEndVnode == null) {\n            newEndVnode = newCh[--newEndIdx];\n        }\n        else if (sameVnode(oldStartVnode, newStartVnode)) { // 判断情况1\n            patchVnode(oldStartVnode, newStartVnode, insertedVnodeQueue);\n            oldStartVnode = oldCh[++oldStartIdx];\n            newStartVnode = newCh[++newStartIdx];\n        }\n        else if (sameVnode(oldEndVnode, newEndVnode)) {   // 情况2\n            patchVnode(oldEndVnode, newEndVnode, insertedVnodeQueue);\n            oldEndVnode = oldCh[--oldEndIdx];\n            newEndVnode = newCh[--newEndIdx];\n        }\n        else if (sameVnode(oldStartVnode, newEndVnode)) { // Vnode moved right情况3\n            patchVnode(oldStartVnode, newEndVnode, insertedVnodeQueue);\n            api.insertBefore(parentElm, oldStartVnode.elm, api.nextSibling(oldEndVnode.elm));\n            oldStartVnode = oldCh[++oldStartIdx];\n            newEndVnode = newCh[--newEndIdx];\n        }\n        else if (sameVnode(oldEndVnode, newStartVnode)) { // Vnode moved left情况4\n            patchVnode(oldEndVnode, newStartVnode, insertedVnodeQueue);\n            api.insertBefore(parentElm, oldEndVnode.elm, oldStartVnode.elm);\n            oldEndVnode = oldCh[--oldEndIdx];\n            newStartVnode = newCh[++newStartIdx];\n        }\n        else {                                             // 情况5\n            if (oldKeyToIdx === undefined) {\n                oldKeyToIdx = createKeyToOldIdx(oldCh, oldStartIdx, oldEndIdx);\n            }\n            idxInOld = oldKeyToIdx[newStartVnode.key];\n            if (isUndef(idxInOld)) { // New element        // 创建新的节点在旧节点的新节点前\n                api.insertBefore(parentElm, createElm(newStartVnode, insertedVnodeQueue), oldStartVnode.elm);\n            }\n            else {\n                elmToMove = oldCh[idxInOld];\n                if (elmToMove.sel !== newStartVnode.sel) { // 创建新的节点在旧节点的新节点前\n                    api.insertBefore(parentElm, createElm(newStartVnode, insertedVnodeQueue), oldStartVnode.elm);\n                }\n                else {\n                                                           // 在旧节点数组中找到相同的节点就对比差异更新视图,然后移动位置\n                    patchVnode(elmToMove, newStartVnode, insertedVnodeQueue);\n                    oldCh[idxInOld] = undefined;\n                    api.insertBefore(parentElm, elmToMove.elm, oldStartVnode.elm);\n                }\n            }\n            newStartVnode = newCh[++newStartIdx];\n        }\n    }\n    // 循环结束的收尾工作\n    if (oldStartIdx <= oldEndIdx || newStartIdx <= newEndIdx) {\n        if (oldStartIdx > oldEndIdx) {\n            // newCh[newEndIdx + 1].elm就是旧节点数组中的结束节点对应的dom元素\n            // newEndIdx+1是因为在之前成功匹配了newEndIdx需要-1\n            // newCh[newEndIdx + 1].elm,因为已经匹配过有相同的节点了,它就是等于旧节点数组中的结束节点对应的dom元素(oldCh[oldEndIdx + 1].elm)\n            before = newCh[newEndIdx + 1] == null ? null : newCh[newEndIdx + 1].elm;\n            // 把新节点数组中多出来的节点插入到before前\n            addVnodes(parentElm, before, newCh, newStartIdx, newEndIdx, insertedVnodeQueue);\n        }\n        else {\n            // 这里就是把没有匹配到相同节点的节点删除掉\n            removeVnodes(parentElm, oldCh, oldStartIdx, oldEndIdx);\n        }\n    }\n}\n复制代码\n")])])]),n("hr"),e._v(" "),n("h4",{attrs:{id:"key的作用"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#key的作用"}},[e._v("#")]),e._v(" key的作用")]),e._v(" "),n("ul",[n("li",[e._v("Diff操作可以"),n("code",[e._v("更加快速")]),e._v(";")]),e._v(" "),n("li",[e._v("Diff操作可以更加准确;"),n("code",[e._v("(避免渲染错误)")])]),e._v(" "),n("li",[n("code",[e._v("不推荐使用索引")]),e._v("作为key")])]),e._v(" "),n("p",[e._v("以下我们看看这些作用的实例:")]),e._v(" "),n("h5",{attrs:{id:"diff操作可以更加准确-避免渲染错误"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#diff操作可以更加准确-避免渲染错误"}},[e._v("#")]),e._v(" Diff操作可以更加准确;"),n("code",[e._v("(避免渲染错误)")]),e._v(":")]),e._v(" "),n("p",[e._v("实例:a,b,c三个dom元素中的b,c间插入一个z元素")]),e._v(" "),n("p",[e._v("没有设置key"),n("img",{attrs:{src:"https://mmbiz.qpic.cn/sz_mmbiz_png/H8M5QJDxMHrBPOs1OFIWuxw354WxNWGLQBlov7cLbsewuYickoDtZ3FLd4nK1icFQnPib2jtradgpQcsLl8laVRibA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}}),e._v("当设置了key:")]),e._v(" "),n("p",[n("img",{attrs:{src:"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==",alt:"图片"}}),e._v("image.png")]),e._v(" "),n("h5",{attrs:{id:"diff操作可以更加准确-避免渲染错误-2"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#diff操作可以更加准确-避免渲染错误-2"}},[e._v("#")]),e._v(" Diff操作可以更加准确;"),n("code",[e._v("(避免渲染错误)")])]),e._v(" "),n("p",[e._v("实例:a,b,c三个dom元素,修改了a元素的某个属性再去在a元素前新增一个z元素")]),e._v(" "),n("p",[e._v("没有设置key:")]),e._v(" "),n("p",[n("img",{attrs:{src:"https://mmbiz.qpic.cn/sz_mmbiz_png/H8M5QJDxMHrBPOs1OFIWuxw354WxNWGLicShV9Z6VakI8f5xOAdNRYtmlHNAmqx4UgOAWztdoicryEgImaNiaKTQQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}}),e._v("image.png")]),e._v(" "),n("p",[n("img",{attrs:{src:"https://mmbiz.qpic.cn/sz_mmbiz_png/H8M5QJDxMHrBPOs1OFIWuxw354WxNWGLppGHLibOEHonGxhLfqeNKp2u4vs6vNvg9OwMrSu3cCjOpuQATp8XicMA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}}),e._v("image.png")]),e._v(" "),n("p",[e._v("因为没有设置key,默认都是undefined,所以节点都是相同的,更新了text的内容但还是沿用了之前的dom,所以实际上"),n("code",[e._v("a->z(a原本打勾的状态保留了,只改变了text),b->a,c->b,d->c")]),e._v(",遍历完毕发现还要增加一个dom,在最后新增一个text为d的dom元素")]),e._v(" "),n("p",[e._v("设置了key:")]),e._v(" "),n("p",[n("img",{attrs:{src:"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==",alt:"图片"}}),e._v("image.png")]),e._v(" "),n("p",[n("img",{attrs:{src:"https://mmbiz.qpic.cn/sz_mmbiz_png/H8M5QJDxMHrBPOs1OFIWuxw354WxNWGL3bJXibeUugGXzPCEDibqhdKqWsibJMibahnicqjfOQfr8JHC5LTSEymKiaGA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}}),e._v("image.png")]),e._v(" "),n("p",[e._v("当设置了key,a,b,c,d都有对应的key,"),n("code",[e._v("a->a,b->b,c->c,d->d")]),e._v(",内容相同无需更新,遍历结束,新增一个text为z的dom元素")]),e._v(" "),n("h5",{attrs:{id:"不推荐使用索引作为key"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#不推荐使用索引作为key"}},[e._v("#")]),e._v(" "),n("code",[e._v("不推荐使用索引")]),e._v("作为key:")]),e._v(" "),n("p",[e._v("设置索引为key:")]),e._v(" "),n("p",[n("img",{attrs:{src:"https://mmbiz.qpic.cn/sz_mmbiz_png/H8M5QJDxMHrBPOs1OFIWuxw354WxNWGLXyG20PYXWkPjWciaFFZPtO6nd3cia8mXE4otXqq1FeYbNb6j0VzFLwyA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}}),e._v("image.png")]),e._v(" "),n("p",[e._v("这明显效率不高,我们只希望找出不同的节点更新,而使用索引作为key会增加运算时间,我们可以把key设置为与节点text为一致就可以解决这个问题:")]),e._v(" "),n("p",[n("img",{attrs:{src:"https://mmbiz.qpic.cn/sz_mmbiz_png/H8M5QJDxMHrBPOs1OFIWuxw354WxNWGLdzMXJFmut6AoNtXKorxW9HAbcMsctLKDrsH3z99F79KApCIGHyZ4rA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}}),e._v("image.png")]),e._v(" "),n("hr"),e._v(" "),n("h2",{attrs:{id:"最后"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#最后"}},[e._v("#")]),e._v(" 最后")]),e._v(" "),n("p",[e._v("如有描述错误或者不明的地方请在下方评论联系我,我会立刻更新,如有收获,请为我点个赞👍这是对我的莫大的支持,谢谢各位")]),e._v(" "),n("p",[e._v("关于本文")]),e._v(" "),n("h1",{attrs:{id:"作者-渣渣xiong"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#作者-渣渣xiong"}},[e._v("#")]),e._v(" 作者：渣渣xiong")]),e._v(" "),n("p",[e._v("https://juejin.cn/post/7000266544181674014")]),e._v(" "),n("p",[e._v("推荐阅读")]),e._v(" "),n("p",[n("a",{attrs:{href:"http://mp.weixin.qq.com/s?__biz=MzAxODE4MTEzMA==&mid=2650090299&idx=1&sn=d08a44bc38d31855fbd7bf9379ed6562&chksm=83dbb65eb4ac3f485cbc0744b6eb10d179cfddd447a1dbe72aab97a8e323a7ea0939d315bc5e&scene=21#wechat_redirect",target:"_blank",rel:"noopener noreferrer"}},[e._v("66 道前端算法面试题附思路分析助你查漏补缺"),n("OutboundLink")],1)])])}),[],!1,null,null,null);n.default=o.exports}}]);